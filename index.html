<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">    
    <title>Smart Billing LIFF V2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #00b900; --bg: #f4f4f7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .app-container { max-width: 500px; margin: auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .header { background: var(--primary); color: white; padding: 20px 15px; display: flex; align-items: center; gap: 10px; }
        .header h3 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: 0.5px; }
        .ai-banner { background: #e8f5e9; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #c8e6c9; }
        .ai-banner b { font-size: 15px; color: #2e7d32; display: flex; align-items: center; gap: 8px; }
        form { padding: 15px; }
        .row { display: flex; gap: 12px; margin-bottom: 15px; flex-wrap: wrap; }
        .field { flex: 1; min-width: 140px; }
        label { display: block; font-size: 13px; margin-bottom: 6px; color: #444; font-weight: 700; }
        input, select { width: 100%; padding: 13px; border: 1.5px solid #e0e0e0; border-radius: 10px; box-sizing: border-box; font-size: 15px; transition: border 0.2s; }
        input:focus { border-color: var(--primary); outline: none; }
        .file-box { border: 2px dashed var(--primary); padding: 35px 20px; text-align: center; border-radius: 14px; cursor: pointer; position: relative; background: #fafafa; margin-bottom: 20px; }
        .file-box i { color: var(--primary); margin-bottom: 10px; }
        .loading-overlay { display: none; position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.9); border-radius: 12px; align-items: center; justify-content: center; flex-direction: column; z-index: 10; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 35px; height: 35px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 17px; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 8px rgba(0,185,0,0.2); }
        button:active { transform: scale(0.98); }
        .status-msg { text-align: center; margin-top: 12px; font-size: 15px; min-height: 24px; font-weight: 500; }
        .ai-toggle-wrapper { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        #aiToggle { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <i class="fas fa-file-invoice-dollar fa-lg"></i>
            <h3>Smart Billing V2</h3>
        </div>
        
        <div class="ai-banner">
            <b><i class="fas fa-robot"></i> AI OCR Auto-Fill</b>
            <div class="ai-toggle-wrapper" onclick="document.getElementById('aiToggle').click(); event.stopPropagation();">
                <input type="checkbox" id="aiToggle" checked onclick="event.stopPropagation();">
            </div>
        </div>

        <form id="taxForm">
            <div class="file-box" onclick="document.getElementById('billFile').click()">
                <div class="loading-overlay" id="aiLoading">
                    <div class="spinner"></div>
                    <div style="margin-top:12px; color:var(--primary); font-weight:bold;">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                </div>
                <i class="fas fa-camera fa-3x"></i><br>
                <span id="fileNameDisplay" style="font-weight: 500; color: #666;">‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</span>
                <input type="file" id="billFile" accept="image/*" style="display:none;" onchange="handleFileChange(this)">
            </div>

            <div class="row">
                <div class="field"><label>Tax ID ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</label><input type="text" id="taxId" placeholder="‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å" required></div>
                <div class="field"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</label><input type="text" id="sellerName" required></div>
            </div>
            <div class="row">
                <div class="field"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</label><input type="text" id="billNumber" required></div>
                <div class="field" style="flex:0.4; min-width: 80px;"><label>‡∏™‡∏≤‡∏Ç‡∏≤</label><input type="text" id="branchCode" value="00000" required></div>
            </div>
            <div class="row">
                <div class="field"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Bill Date)</label><input type="date" id="billDate" required></div>
            </div>
            <div class="row">
                <div class="field"><label>‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT</label><input type="number" step="0.01" id="preVat" oninput="calculateTotal()" required></div>
                <div class="field"><label>VAT</label><input type="number" step="0.01" id="vatAmount" oninput="calculateTotal()" required></div>
            </div>
            <div class="row">
                <div class="field"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label><input type="number" id="totalAmount" readonly style="background:#f0f0f0; font-weight:bold; color:var(--primary);"></div>
            </div>
            <div class="row">
                <div class="field" style="flex:0.6;"><label>Project</label><input type="text" id="projectCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" required></div>
                <div class="field"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</label><input type="text" id="requesterName" required></div>
            </div>
            <div class="row">
                <div class="field">
                    <label>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve Request)</label>
                    <select id="approve_request" required><option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... --</option></select>
                </div>
            </div>
            <div class="row"><div class="field"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="expenseNote" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></div></div>

            <button type="button" id="submitBtn" onclick="submitForm()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <div id="status" class="status-msg"></div>
        </form>
    </div>

    <script>
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx1jZ1HFaG-eqs_Mx8PZ9WlUqprgut_TTJoDF-0GpMRJfATFys-nfWkuIW-CM-PrcQQ/exec"; 
        const LIFF_ID = "2009016720-H0IBJAkd";
        let userData = { userId: "", displayName: "", email: "" };
        let currentFileBase64 = "", currentFileType = "";

        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); } 
                else {
                    const profile = await liff.getProfile();
                    userData = { userId: profile.userId, displayName: profile.displayName, email: liff.getDecodedIDToken()?.email || "" };
                    document.getElementById('requesterName').value = profile.displayName;
                    loadApprovers();
                }
            } catch (err) { console.error("LIFF Init Error:", err); }
        }

        async function loadApprovers() {
            try {
                const res = await fetch(GAS_WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "getApprovers" })});
                const json = await res.json();
                if (json.success) {
                    const select = document.getElementById('approve_request');
                    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ --</option>';
                    json.data.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name; opt.innerText = name;
                        select.appendChild(opt);
                    });
                }
            } catch (e) { document.getElementById('status').innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ"; }
        }

        window.onload = initLIFF;

        function calculateTotal() {
            const v1 = parseFloat(document.getElementById('preVat').value) || 0;
            const v2 = parseFloat(document.getElementById('vatAmount').value) || 0;
            document.getElementById('totalAmount').value = (v1 + v2).toFixed(2);
        }

        async function handleFileChange(input) {
            const file = input.files[0]; if (!file) return;
            document.getElementById('fileNameDisplay').innerText = file.name;
            currentFileType = file.type;
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                currentFileBase64 = reader.result.split(',')[1];
                if (document.getElementById('aiToggle').checked) {
                    document.getElementById('aiLoading').style.display = 'flex';
                    try {
                        const res = await fetch(GAS_WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "analyze", base64: currentFileBase64, type: file.type })});
                        const json = await res.json();
                        if (json.success) {
                            const d = json.data;
                            document.getElementById('taxId').value = d.taxId || "";
                            document.getElementById('sellerName').value = d.sellerName || "";
                            document.getElementById('billNumber').value = d.billNumber || "";
                            document.getElementById('billDate').value = d.billDate || "";
                            document.getElementById('preVat').value = d.preVat || 0;
                            document.getElementById('vatAmount').value = d.vatAmount || 0;
                            document.getElementById('expenseNote').value = d.expenseNote || "";
                            calculateTotal();
                        } else {
                            throw new Error(json.message);
                        }
                    } catch (e) { 
                        console.error(e);
                        alert("AI Error: " + e.message);
                    }
                    document.getElementById('aiLoading').style.display = 'none';
                }
            };
        }

        async function submitForm() {
            const form = document.getElementById('taxForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            const btn = document.getElementById('submitBtn'); btn.disabled = true;
            const status = document.getElementById('status'); status.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

            const payload = {
                taxId: document.getElementById('taxId').value,
                sellerName: document.getElementById('sellerName').value,
                branchCode: document.getElementById('branchCode').value,
                billNumber: document.getElementById('billNumber').value,
                billDate: document.getElementById('billDate').value,
                preVat: document.getElementById('preVat').value,
                vatAmount: document.getElementById('vatAmount').value,
                totalAmount: document.getElementById('totalAmount').value,
                projectCode: document.getElementById('projectCode').value,
                requesterName: document.getElementById('requesterName').value,
                expenseNote: document.getElementById('expenseNote').value,
                approve_request: document.getElementById('approve_request').value,
                fileBase64: currentFileBase64, fileType: currentFileType,
                lineUserId: userData.userId, lineEmail: userData.email
            };

            try {
                const res = await fetch(GAS_WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "submit", formData: payload })});
                const json = await res.json();
                if (json.success) {
                    status.innerHTML = "<b style='color:green;'>‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</b>";
                    
                    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Line Chat ---
                    if (liff.isInClient()) {
                        const summaryText = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß\n` +
                                          `--------------------\n` +
                                          `üë§ ‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å: ${payload.requesterName}\n` +
                                          `üè¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢: ${payload.sellerName}\n` +
                                          `üìÑ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•: ${payload.billNumber}\n` +
                                          `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${payload.billDate}\n` +
                                          `üí∞ ‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT: ${payload.preVat} ‡∏ø\n` +
                                          `üßß VAT: ${payload.vatAmount} ‡∏ø\n` +
                                          `--------------------\n` +
                                          `üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${payload.totalAmount} ‡∏ø`;
                        try {
                            await liff.sendMessages([{ type: 'text', text: summaryText }]);
                        } catch (err) {
                            console.error("Send message failed", err);
                        }
                    }
                    
                    // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
                    setTimeout(() => liff.closeWindow(), 2000);
                } else {
                    status.innerText = "‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + json.message;
                    btn.disabled = false;
                }
            } catch (e) { status.innerText = "‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"; btn.disabled = false; }
        }
    </script>
</body>
</html>