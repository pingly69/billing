<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (LIFF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONFIGURATION ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyF_RWhcxaPU_IblvklPLCwC0OvHVe_nHXV9PY5JNPPzY_oWpM8Yde90vfzLm47PGoEoQ/exec"; 
        const LIFF_ID = "2009016720-H0IBJAkd";
        const FIX_RATE = 4;

        const Icons = {
            Car: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>,
            Loader: (props) => <svg {...props} className={props.className + " animate-spin"} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            Image: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        };

        const App = () => {
            const [formData, setFormData] = useState({
                request_date: new Date().toISOString().split('T')[0],
                requester_name: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', team_name: '', site_name: '', travel_details: '',
                origin: '', destination: '', trip_type: '‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß',
                distance_km: 0, toll_fee: 0, parking_fee: 0,
                line_user_id: '' // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÄ‡∏Å‡πá‡∏ö LINE User ID
            });
            const [selectedFile, setSelectedFile] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const initLiff = async () => {
                    try {
                        await liff.init({ liffId: LIFF_ID });
                        if (liff.isLoggedIn()) {
                            const profile = await liff.getProfile();
                            // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏î‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ User ID ‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô State
                            setFormData(prev => ({ 
                                ...prev, 
                                requester_name: profile.displayName,
                                line_user_id: profile.userId
                            }));
                        } else {
                            liff.login();
                        }
                    } catch (err) {
                        console.error("LIFF Init Error:", err);
                        setFormData(prev => ({ ...prev, requester_name: "User (Error Profile)" }));
                    }
                };
                initLiff();
            }, []);

            const mileageAmount = Number(formData.distance_km) * FIX_RATE;
            const totalAmount = mileageAmount + Number(formData.toll_fee) + Number(formData.parking_fee);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file && file.size <= 5 * 1024 * 1024) {
                    setSelectedFile(file);
                } else if (file) {
                    alert("‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB");
                    e.target.value = null;
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                let fileData = null;
                let fileName = null;

                if (selectedFile) {
                    const reader = new FileReader();
                    fileData = await new Promise(resolve => {
                        reader.onload = (ev) => resolve(ev.target.result);
                        reader.readAsDataURL(selectedFile);
                    });
                    fileName = selectedFile.name;
                }

                const payload = {
                    ...formData,
                    mileage_amount: mileageAmount,
                    total_amount: totalAmount,
                    update_datetime: new Date().toLocaleString('th-TH'),
                    fileData, fileName
                };

                try {
                    // 1. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Apps Script
                    await fetch(GAS_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô LINE Chat (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ LINE)
                    if (liff.isInClient()) {
                        const summaryText = 
                            `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n` +
                            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                            `üë§ ‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å: ${payload.requester_name}\n` +
                            `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${payload.request_date}\n` +
                            `üìç Site ‡∏á‡∏≤‡∏ô: ${payload.site_name}\n` +
                            `üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${payload.travel_details}\n` +
                            `üöó ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${payload.distance_km} ‡∏Å‡∏°.\n` +
                            `üõ£Ô∏è ‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô: ${Number(payload.toll_fee).toLocaleString()} ‡∏ø\n` +
                            `üÖøÔ∏è ‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ/‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î: ${Number(payload.parking_fee).toLocaleString()} ‡∏ø\n` +
                            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                            `üí∞ ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${payload.total_amount.toLocaleString()} ‡∏ø`;

                        try {
                            await liff.sendMessages([{ type: 'text', text: summaryText }]);
                        } catch (sendErr) {
                            console.error("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Scopes):", sendErr);
                        }
                        
                        // 3. ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                        liff.closeWindow();
                    } else {
                        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÇ‡∏´‡∏°‡∏î Browser)");
                        window.location.reload();
                    }
                    
                } catch (err) {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="py-4 px-3 max-w-md mx-auto">
                    {/* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ */}
                    <div className="bg-white rounded-2xl shadow-md border-b p-4 flex items-center gap-3 mb-4">
                        <div className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
                            <Icons.Car className="w-6 h-6" />
                        </div>
                        <div>
                            <h1 className="text-lg font-bold text-slate-800 leading-none">‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h1>
                            <span className="text-[10px] text-slate-400 uppercase font-bold tracking-widest">LINE LIFF System</span>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="bg-white shadow-xl rounded-2xl p-5 space-y-4">
                        <div className="space-y-4">
                            {/* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å LINE Profile */}
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 mb-1 block uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å LINE)</label>
                                <input type="text" readOnly value={formData.requester_name} className="w-full p-2.5 bg-slate-100 border border-slate-200 rounded-lg text-slate-600 font-bold outline-none" />
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 mb-1 block uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input type="date" value={formData.request_date} onChange={e => setFormData({...formData, request_date: e.target.value})} className="w-full p-2 border border-slate-200 rounded-lg text-sm" />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 mb-1 block uppercase">‡∏ó‡∏µ‡∏° / ‡∏ù‡πà‡∏≤‡∏¢</label>
                                    <input type="text" value={formData.team_name} onChange={e => setFormData({...formData, team_name: e.target.value})} className="w-full p-2 border border-slate-200 rounded-lg text-sm" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡∏°" />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] font-bold text-slate-400 mb-1 block uppercase">Site ‡∏á‡∏≤‡∏ô / ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
                                <input type="text" value={formData.site_name} onChange={e => setFormData({...formData, site_name: e.target.value})} className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" placeholder="‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?" required />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 mb-1 block uppercase">‡∏à‡∏≤‡∏Å (‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á)</label>
                                    <input type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á" value={formData.origin} onChange={e => setFormData({...formData, origin: e.target.value})} className="w-full p-2 border border-slate-200 rounded-lg text-xs" required />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 mb-1 block uppercase">‡∏ñ‡∏∂‡∏á (‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á)</label>
                                    <input type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" value={formData.destination} onChange={e => setFormData({...formData, destination: e.target.value})} className="w-full p-2 border border-slate-200 rounded-lg text-xs" required />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] font-bold text-slate-400 mb-1 block uppercase">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
                                <textarea placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." rows="2" value={formData.travel_details} onChange={e => setFormData({...formData, travel_details: e.target.value})} className="w-full p-2 border border-slate-200 rounded-lg text-sm bg-slate-50" required></textarea>
                            </div>

                            {/* ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) */}
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 mb-1 block uppercase">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                                <div className="relative">
                                    <input type="file" accept="image/*" onChange={handleFileChange} className="hidden" id="file-input" />
                                    <label htmlFor="file-input" className="flex items-center justify-center gap-2 p-3 border-2 border-dashed border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition-all text-slate-500 text-sm">
                                        <Icons.Image className="w-5 h-5" />
                                        {selectedFile ? <span className="text-blue-600 font-bold truncate max-w-[150px]">{selectedFile.name}</span> : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...'}
                                    </label>
                                </div>
                            </div>
                            
                            <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100 space-y-3">
                                <div className="grid grid-cols-2 gap-2">
                                    <div className="col-span-2">
                                        <label className="text-[9px] font-bold text-blue-800 uppercase mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
                                        <select value={formData.trip_type} onChange={e => setFormData({...formData, trip_type: e.target.value})} className="w-full p-2 bg-white border border-blue-200 rounded-lg text-xs font-bold">
                                            <option>‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option><option>‡πÑ‡∏õ‡∏Å‡∏•‡∏±‡∏ö</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-[9px] font-bold text-blue-800 uppercase mb-1 block">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</label>
                                        <input type="number" value={formData.distance_km} onChange={e => setFormData({...formData, distance_km: e.target.value})} className="w-full p-2 border border-blue-200 rounded-lg text-center font-bold" />
                                    </div>
                                    <div>
                                        <label className="text-[9px] font-bold text-blue-800 uppercase mb-1 block">‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô (‡∏ø)</label>
                                        <input type="number" value={formData.toll_fee} onChange={e => setFormData({...formData, toll_fee: e.target.value})} className="w-full p-2 border border-blue-200 rounded-lg text-center" placeholder="0" />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="text-[9px] font-bold text-blue-800 uppercase mb-1 block">‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ/‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î (‡∏ø)</label>
                                        <input type="number" value={formData.parking_fee} onChange={e => setFormData({...formData, parking_fee: e.target.value})} className="w-full p-2 border border-blue-200 rounded-lg text-center" placeholder="0" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å */}
                        <div className="pt-2">
                            <div className="bg-blue-600 rounded-2xl p-4 text-white mb-4 flex justify-between items-center shadow-lg border border-white/20">
                                <div className="text-xs opacity-80 font-bold uppercase tracking-widest">‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                                <div className="text-3xl font-black tracking-tight">{totalAmount.toLocaleString()} ‡∏ø</div>
                            </div>
                            <button type="submit" disabled={loading || totalAmount <= 0} className={`w-full py-4 rounded-2xl font-bold text-lg shadow-xl flex items-center justify-center gap-3 transition-all ${loading ? 'bg-slate-300' : 'bg-slate-800 text-white active:scale-95'}`}>
                                {loading ? <Icons.Loader className="w-6 h-6" /> : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>